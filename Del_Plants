-- Config
_G.KeepAmount = {
    Bamboo = 4,
    Coconut = 8,
    Mushroom = 4,
    Glowthorn = 4,
    Tomato = 8,
    Pumpkin = 4,
    Pepper = 4,
    Cacao = 8,
    Apple = 8,
    Romanesco = 4,
    ["Elder Strawberry"] = 4,
    ["Burning Bud"] = 4,
    ["Giant Pinecone"] = 4,
    Corn = 4,
    ["Sugar Apple"] = 4,
    ["Ember Lily"] = 4,
    ["Dragon Fruit"] = 8,
    Sunbulb = 8,
    ["Orange Tulip"] = 4,
    Blueberry = 8,
    Watermelon = 4,
    Mango = 8,
    Cactus = 4,
    Strawberry = 8,
    Beanstalk = 4,
    Lightshoot = 4,
    Grape = 4,
    Daffodil = 4
}

_G.Treelist = {
    "Moon Blossom",
    "Bone Blossom",
    "Moon Melon",
    "Maple Apple",
    "Moon Mango",
    "Dragon Pepper",
    "Elephant Ears",
    "Fossilight",
    "Princess Thorn"
}

_G.Remove = true
_G.MaxPlants = 168

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

local function getOwnedPlot()
    for _, plot in pairs(workspace.Farm:GetChildren()) do
        local important = plot:FindFirstChild("Important") or plot:FindFirstChild("Importanert")
        if important then
            local data = important:FindFirstChild("Data")
            if data and data:FindFirstChild("Owner") and data.Owner.Value == player.Name then
                return plot
            end
        end
    end
    return nil
end

local function EquipShovel()
    local backpack = player:FindFirstChild("Backpack")
    local character = player.Character
    local shovel = nil
    if backpack then
        shovel = backpack:FindFirstChild("Shovel [Destroy Plants]") 
    end
    if not shovel and character then
        shovel = character:FindFirstChild("Shovel [Destroy Plants]")
    end
    if shovel and character and shovel.Parent ~= character then
        shovel.Parent = character
    end
end

-- Kiểm tra tên cây có trong Treelist (exact match)
local function isInTreelist(treeName)
    for _, name in pairs(_G.Treelist) do
        if treeName == name then
            return true
        end
    end
    return false
end

-- Đếm tổng số cây trong plot (Model) và đếm từng loại theo exact-match với _G.KeepAmount
local function countPlants(plot)
    local total = 0
    local typeCounts = {}
    for k, _ in pairs(_G.KeepAmount) do
        typeCounts[k] = 0
    end

    if not plot or not plot:FindFirstChild("Important") then
        return 0, typeCounts
    end
    local plantsFolder = plot.Important:FindFirstChild("Plants_Physical")
    if not plantsFolder then
        return 0, typeCounts
    end

    for _, plant in pairs(plantsFolder:GetChildren()) do
        if plant:IsA("Model") then
            total = total + 1
            for key, _ in pairs(_G.KeepAmount) do
                if plant.Name == key then
                    typeCounts[key] = (typeCounts[key] or 0) + 1
                    break
                end
            end
        end
    end

    return total, typeCounts
end

local processing = false
local function DestroyTree()
    if processing then return end
    processing = true

    local ok, err = pcall(function()
        if not _G.Remove then return end

        local plot = getOwnedPlot()
        if not plot then return end

        local plantsFolder = plot.Important and plot.Important:FindFirstChild("Plants_Physical")
        if not plantsFolder then return end

        local total, typeCounts = countPlants(plot)
        if total <= (_G.MaxPlants or 120) then
            return
        end

        EquipShovel()

        for _, plant in pairs(plantsFolder:GetChildren()) do
            if total <= (_G.MaxPlants or 120) then break end
            if plant:IsA("Model") then
                local name = plant.Name

                if isInTreelist(name) then
                    -- skip nếu nằm trong Treelist
                else
                    local canDelete = true
                    local matchedKey = nil
                    if _G.KeepAmount then
                        for key, keepNum in pairs(_G.KeepAmount) do
                            if name == key then
                                matchedKey = key
                                local currentOfType = typeCounts[key] or 0
                                if currentOfType <= keepNum then
                                    canDelete = false
                                end
                                break
                            end
                        end
                    end

                    if canDelete then
                        local part = plant.PrimaryPart or plant:FindFirstChildWhichIsA("BasePart")
                        if part then
                            ReplicatedStorage.GameEvents.Remove_Item:FireServer(part)
                            total = total - 1
                            if matchedKey then
                                typeCounts[matchedKey] = (typeCounts[matchedKey] or 1) - 1
                            end
                            print("[AutoRemove] Removed:", name, " - remaining total:", total)
                            task.wait(0.05)
                        end
                    end
                end
            end
        end
    end)

    if not ok then
        warn("Lỗi khi xóa cây: " .. tostring(err))
    end

    processing = false
end

while task.wait(0.5) do
    DestroyTree()
end
